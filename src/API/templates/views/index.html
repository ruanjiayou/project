<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="Author" content="阮家友" />
    <meta name="Keywords" content="HTML,model,test" />
    <meta name="Description" content="special effect model" />
    <meta name="time" content="2015-9-27 10:41:48" />
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0"
    />
    <title>test</title>
    <link rel="stylesheet" href="http://127.0.0.1:2017/css/common.css" />
    <link rel="stylesheet" href="http://127.0.0.1:2017/css/common.layout.css" />
    <link rel="stylesheet" href="http://127.0.0.1:2017/css/common.button.css" />
    <link rel="stylesheet" href="http://127.0.0.1:2017/css/common.pagination.css" />
    <link rel="stylesheet" href="http://127.0.0.1:2017/css/common.table.css" />
    <link rel="stylesheet" href="http://127.0.0.1:2017/css/common.page.css" />
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/styles/jquery.magnify.css">

    <script src="http://127.0.0.1:2017/js/jquery.js"></script>
    <script src="/scripts/jquery.magnify.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            position: relative;
        }

        img {
            width: 220px;
            display: block;
        }

        .item {
            box-shadow: 2px 2px 2px #999;
            position: absolute;
        }
    </style>
</head>

<body>
    <div id="box"></div>
    <script>
        var box = document.getElementById('box');
        var items = box.children;
        // 定义每一列之间的间隙 为10像素
        var gap = 10, page = 3, loading = false;

        window.onload = function () {
            $('[data-magnify=gallery]').magnify();
            // 一进来就调用一次
            //waterFall();
            loadData(waterFall);
            function loadData(func) {
                $.ajax({
                    url: '/images?limit=30&page=' + page,
                    type: 'get',
                    dataType: 'json',
                    success: function (d) {
                        if (d && d.status === true) {
                            var datas = d.result;
                            for (var i = 0; i < datas.length; i++) {
                                var div = document.createElement("div");
                                var href = 'http://nodejs.blog.jiayou.com/ueditor/php/upload/' + datas[i].path;
                                div.className = "item";
                                div.setAttribute('href', href);
                                div.setAttribute('data-magnify', "gallery");
                                div.innerHTML = '<img src="' + href + '" alt="">';
                                box.appendChild(div);
                            }
                            if (typeof func === 'function') {
                                func();
                            }
                        }
                    },
                    error: function (err) {

                    },
                    complete: function(){
                        loading = false;
                    }
                });
            }
            // 封装成一个函数
            function waterFall() {
                if (items.length === 0) return;
                // 1- 确定列数  = 页面的宽度 / 图片的宽度
                var pageWidth = getClient().width;
                var itemWidth = items[0].offsetWidth;
                var columns = parseInt(pageWidth / (itemWidth + gap));
                var arr = [];
                for (var i = 0; i < items.length; i++) {
                    if (i < columns) {
                        // 2- 确定第一行
                        items[i].style.top = 0;
                        items[i].style.left = (itemWidth + gap) * i + 'px';
                        arr.push(items[i].offsetHeight);

                    } else {
                        // 其他行
                        // 3- 找到数组中最小高度  和 它的索引
                        var minHeight = arr[0];
                        var index = 0;
                        for (var j = 0; j < arr.length; j++) {
                            if (minHeight > arr[j]) {
                                minHeight = arr[j];
                                index = j;
                            }
                        }
                        // 4- 设置下一行的第一个盒子位置
                        // top值就是最小列的高度 + gap
                        items[i].style.top = arr[index] + gap + 'px';
                        // left值就是最小列距离左边的距离
                        items[i].style.left = items[index].offsetLeft + 'px';

                        // 5- 修改最小列的高度 
                        // 最小列的高度 = 当前自己的高度 + 拼接过来的高度 + 间隙的高度
                        arr[index] = arr[index] + items[i].offsetHeight + gap;
                    }
                }
            }
            // 页面尺寸改变时实时触发
            window.onresize = function () {
                waterFall();
            };
            // 当加载到第30张的时候
            window.onscroll = function () {
                if (loading === false && getClient().height + getScrollTop() >= items[items.length - 1].offsetTop) {
                    page++;
                    loading = true;
                    loadData(waterFall);
                }
            };
        };

        // clientWidth 处理兼容性
        function getClient() {
            return {
                width: window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth,
                height: window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight
            }
        }
        // scrollTop兼容性处理
        function getScrollTop() {
            return window.pageYOffset || document.documentElement.scrollTop;
        }
    </script>
</body>

</html>